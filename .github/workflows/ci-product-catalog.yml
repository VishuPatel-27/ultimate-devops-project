# CI for Product Catalog Service
name: product-catalog-ci


# Trigger the workflow on certain events including, 
# 1. Pull requests to main branch
# 2. Pushes to main branch
# 3. Changes to files in the product-catalog directory
# 4. Changes to this workflow file

on: 
  pull_request:
    branches:
      - main
  push:
    branches:
      - main
    paths:
      - 'src/product-catalog/**'
      - '.github/workflows/ci-product-catalog.yml'

# Define the jobs to be run in the workflow
jobs:
    # 1. Build the Go application and run unit tests
    build:
      runs-on: ubuntu-latest # Github-hosted runner with Ubuntu OS
      steps:
      # Checkout the code from the repository
      - name: checkout code
        uses: actions/checkout@v4 
      # Set up Go environment with specified version
      - name: Setup Go 1.22
        uses: actions/setup-go@v2
        with:
          go-version: 1.22
      # Build the Go application
      - name: Build
        run: |
          cd src/product-catalog
          go mod download
          go build -o product-catalog-service main.go
      # Run unit tests for the Go application
      - name: unit tests
        run: |
          cd src/product-catalog
          go test ./...
    
    # 2. Code Quality Check using golangci-lint
    # golanci-lint is a prewritten actions for running linters on Go code
    code-quality:
        runs-on: ubuntu-latest  # Github-hosted runner with Ubuntu OS

        # Checkout the code from the repository
        steps:
        - name: checkout code
          uses: actions/checkout@v4
        # Set up Go environment with specified version
        - name: Setup Go 1.22
          uses: actions/setup-go@v2
          with:
           go-version: 1.22
        # Run golangci-lint to check code quality
        # Linting helps to identify potential issues and maintain code standards
        # E.g., unused variables, formatting issues, unused imports and functions etc.
        - name: Run golangci-lint
          uses: golangci/golangci-lint-action@v6
          with:
            version: v1.55.2
            run: golangci-lint run
            working-directory: src/product-catalog
    
    # 3. Build and Push Docker Image to Docker Hub
    docker-build-and-push:
        runs-on: ubuntu-latest  # Github-hosted runner with Ubuntu OS

        # This job depends on the successful completion of the 'build' job
        # Which means it will only run if the 'build' job passes
        needs: build

        steps:
        # Checkout the code from the repository
        - name: checkout code
          uses: actions/checkout@v4
      
        - name: Install Docker
          uses: docker/setup-buildx-action@v1
        
        # Login to Docker Hub using credentials stored in GitHub Secrets
        - name: Login to Docker
          uses: docker/login-action@v3
          with:
            username: ${{ vars.DOCKER_USERNAME }}
            password: ${{ secrets.DOCKER_TOKEN }}
        
        # Build and push the Docker image to Docker Hub
        - name: Docker Push
          uses: docker/build-push-action@v6
          with:
            context: src/product-catalog
            file: src/product-catalog/Dockerfile
            push: true
            tags: ${{ vars.DOCKER_USERNAME }}/devops-otel-product-catalog:${{github.run_id}}

    # 4. Update Kubernetes Deployment Manifest with New Image Tag
    update-kubernetestes-manifest:
        runs-on: ubuntu-latest  # Github-hosted runner with Ubuntu OS

        # This job depends on the successful completion of the 'docker-build-and-push' job
        needs: docker-build-and-push

        steps:
        # Checkout the code from the repository with write access (Token)
        - name: checkout code
          uses: actions/checkout@v4
          with:
            token: ${{ secrets.ULTIMATE_DEVOPS_PROJECT_GITHUB_TOKEN }}

        # Update the image tag in the Kubernetes deployment manifest file
        # Here we are using 'sed' command to find and replace the image tag
        - name: Update tag in kubernetes deployment manifest
          run: | 
               sed -i "s|image: .*|image: ${{ vars.DOCKER_USERNAME }}/devops-otel-product-catalog:${{github.run_id}}|" kubernetes/productcatalog/deploy.yaml
        
        - name: Commit and push changes
          run: |
            git config --global user.email ${{ secrets.GIT_USER_EMAIL }}
            git config --global user.name ${{ vars.GIT_USER_NAME }}
            git add kubernetes/productcatalog/deploy.yaml
            git commit -m "[CI]: Update product catalog image tag"
            git push origin HEAD:main -f

        
        
          


        